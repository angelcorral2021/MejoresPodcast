---
import type { Podcast } from '../types/podcast';

interface Props {
  podcast: Podcast;
  showLikeButton?: boolean;
}

const { podcast, showLikeButton = true } = Astro.props;
const podcastUrl = `/podcast/${podcast.id}`;
---

<div class="podcast-card group" data-podcast-id={podcast.id}>
  <a href={podcastUrl} class="card-link">
    <div class="thumbnail-container">
      <img 
        src={podcast.thumbnail} 
        alt={podcast.title}
        class="thumbnail-image"
        loading="lazy"
        decoding="async"
        width="640"
        height="360"
      />
      <div class="play-overlay">
        <svg class="play-icon" fill="currentColor" viewBox="0 0 20 20">
          <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
        </svg>
      </div>
      {podcast.duration && (
        <div class="duration-badge">
          {podcast.duration}
        </div>
      )}
      {podcast.isCult && (
        <div class="cult-badge">
          <svg class="cult-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
          De Culto
        </div>
      )}
    </div>
    <div class="card-content">
      <div class="card-header">
        <div class="category-tag">{podcast.category}</div>
        {podcast.rating && (
          <div class="rating-badge">
            <svg class="star-icon" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            {podcast.rating.toFixed(1)}
          </div>
        )}
      </div>
      <h3 class="card-title">{podcast.title}</h3>
      <p class="card-description">{podcast.description}</p>
      <div class="card-footer">
        <div class="podcast-info">
          {podcast.podcastId ? (
            <a href={`/show/${podcast.podcastId}`} class="podcast-name-link" onclick="event.stopPropagation()">
              {podcast.podcastName}
            </a>
          ) : (
            <span class="podcast-name">{podcast.podcastName}</span>
          )}
          {podcast.episodeNumber && (
            <span class="episode-number">Ep. {podcast.episodeNumber}</span>
          )}
        </div>
        <span class="card-date">{new Date(podcast.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
      </div>
    </div>
  </a>
  {showLikeButton && (
    <button 
      class="like-button"
      data-podcast-id={podcast.id}
      aria-label="Dar like"
    >
      <svg class="like-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
      </svg>
      <span class="like-count" data-like-count={podcast.id}>
        {podcast.likes || 0}
      </span>
    </button>
  )}
</div>

<style>
  .podcast-card {
    @apply relative bg-white dark:bg-gray-800 rounded-xl shadow-lg dark:shadow-gray-900/50 overflow-hidden transition-all duration-300 hover:shadow-2xl dark:hover:shadow-gray-900 hover:-translate-y-1;
  }

  .card-link {
    @apply block;
  }

  .thumbnail-container {
    @apply relative aspect-video w-full overflow-hidden bg-gray-200 dark:bg-gray-700;
  }

  .thumbnail-image {
    @apply w-full h-full object-cover transition-transform duration-300 group-hover:scale-110;
  }

  .play-overlay {
    @apply absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 transition-all duration-300 group-hover:bg-opacity-40;
  }

  .play-icon {
    @apply w-16 h-16 text-white opacity-0 transition-opacity duration-300 group-hover:opacity-100 transform scale-75 group-hover:scale-100;
  }

  .duration-badge {
    @apply absolute bottom-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-sm font-medium;
  }

  .cult-badge {
    @apply absolute top-2 left-2 flex items-center gap-1 bg-yellow-500 text-white px-2 py-1 rounded text-xs font-bold;
  }

  .cult-icon {
    @apply w-3 h-3;
  }

  .card-content {
    @apply p-6;
  }

  .card-header {
    @apply flex items-center justify-between mb-3;
  }

  .category-tag {
    @apply inline-block px-3 py-1 bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 rounded-full text-xs font-semibold;
  }

  .rating-badge {
    @apply flex items-center gap-1 text-yellow-500 text-sm font-semibold;
  }

  .star-icon {
    @apply w-4 h-4 fill-current;
  }

  .card-title {
    @apply text-xl font-bold text-gray-900 dark:text-white mb-2 line-clamp-2 min-h-[3.5rem];
  }

  .card-description {
    @apply text-gray-600 dark:text-gray-400 text-sm mb-4 line-clamp-3;
  }

  .card-footer {
    @apply flex items-center justify-between text-xs text-gray-500 dark:text-gray-400;
  }

  .podcast-info {
    @apply flex items-center gap-2;
  }

  .podcast-name {
    @apply font-semibold text-gray-700 dark:text-gray-300;
  }

  .podcast-name-link {
    @apply font-semibold text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 transition-colors;
  }

  .episode-number {
    @apply px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded;
  }

  .card-date {
    @apply ml-auto;
  }

  .like-button {
    @apply absolute top-4 right-4 flex items-center gap-1 bg-white dark:bg-gray-800 rounded-full px-3 py-2 shadow-md hover:shadow-lg transition-all duration-300 hover:scale-110 z-10;
    @apply text-gray-700 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400;
  }

  .like-button.liked {
    @apply text-red-500 dark:text-red-400;
  }

  .like-button:active {
    @apply scale-95;
  }

  .like-icon {
    @apply w-5 h-5 transition-all duration-300;
  }

  .like-button.liked .like-icon {
    @apply scale-125 fill-current;
    animation: likePulse 0.6s ease-out;
  }

  .like-count {
    @apply font-semibold text-sm transition-all duration-300;
  }

  .like-button.liked .like-count {
    animation: countBounce 0.6s ease-out;
  }

  @keyframes likePulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.5);
    }
    100% {
      transform: scale(1.25);
    }
  }

  @keyframes countBounce {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.3);
    }
  }
</style>

<script>
  // Gestión de likes en el cliente
  function initLikeButtons() {
    const likeButtons = document.querySelectorAll('.like-button');
    
    likeButtons.forEach(button => {
      const podcastId = button.getAttribute('data-podcast-id');
      if (!podcastId) return;

      // Verificar si ya tiene like
      if (typeof window !== 'undefined') {
        const likedPodcasts = localStorage.getItem('user_liked_podcasts');
        if (likedPodcasts) {
          try {
            const liked: string[] = JSON.parse(likedPodcasts);
            if (liked.includes(podcastId)) {
              button.classList.add('liked');
            }
          } catch (e) {
            console.error('Error parsing liked podcasts:', e);
          }
        }
      }

      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        handleLike(podcastId, button);
      });
    });
  }

  function handleLike(podcastId: string, button: Element) {
    if (typeof window === 'undefined') return;

    // Obtener likes actuales
    const likesData = localStorage.getItem('podcast_likes');
    let likes: { [key: string]: number } = {};
    
    if (likesData) {
      try {
        likes = JSON.parse(likesData);
      } catch (e) {
        console.error('Error parsing likes:', e);
      }
    }

    // Verificar si ya tiene like del usuario
    const userLiked = localStorage.getItem('user_liked_podcasts');
    let liked: string[] = [];
    
    if (userLiked) {
      try {
        liked = JSON.parse(userLiked);
      } catch (e) {
        liked = [];
      }
    }

    const isLiked = liked.includes(podcastId);
    const currentLikes = likes[podcastId] || 0;

    if (isLiked) {
      // Quitar like
      liked = liked.filter(id => id !== podcastId);
      likes[podcastId] = Math.max(0, currentLikes - 1);
      button.classList.remove('liked');
    } else {
      // Agregar like
      liked.push(podcastId);
      likes[podcastId] = currentLikes + 1;
      button.classList.add('liked');
    }

    // Guardar en localStorage
    localStorage.setItem('podcast_likes', JSON.stringify(likes));
    localStorage.setItem('user_liked_podcasts', JSON.stringify(liked));

    // Actualizar contador visual
    const countElement = button.querySelector('.like-count');
    if (countElement) {
      countElement.textContent = likes[podcastId].toString();
    }

    // Disparar evento para otros componentes
    window.dispatchEvent(new CustomEvent('podcast-liked', {
      detail: { podcastId, likes: likes[podcastId] }
    }));
  }

  // Inicializar cuando el DOM esté listo
  if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLikeButtons);
    } else {
      initLikeButtons();
    }

    // Escuchar eventos de like desde otros componentes
    window.addEventListener('podcast-liked', (e: Event) => {
      const customEvent = e as CustomEvent;
      const { podcastId, likes } = customEvent.detail;
      const countElement = document.querySelector(`.like-count[data-like-count="${podcastId}"]`);
      if (countElement) {
        countElement.textContent = likes.toString();
      }
    });
  }
</script>

